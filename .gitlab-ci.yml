image: maven:3-jdk-11

stages:
    - build
    - test
    - image

services:
   - name: docker:18-dind
     alias: thedockerhost

variables:
    DOCKER_HOST: tcp://thedockerhost:2375/
    # Use the overlayfs driver for improved performance:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""

#Build stage
buildAuthService:
    stage: build
    script:
        - cd authService
        - mvn package -Dmaven.test.skip=true

buildProfileService:
    stage: build
    script:
        - cd profileService
        - mvn package -Dmaven.test.skip=true

#Test stage
testAuthService:
    stage: test
    needs: ["buildAuthService"]
    script:
        - cd authService
        - mvn test

testProfileService:
    stage: test
    needs: ["buildProfileService"]
    script:
        - cd profileService
        - mvn test

#Build and push docker image
imageAuthService:
    stage: image
    image: docker:18-dind
    needs: ["testAuthService"]
    script: 
        - cd authService
        - docker build . -t timgroenen/kwetterauthservice
        - docker login --username $dockerUsername --password $dockerPassword
        - docker push timgroenen/kwetterauthservice
