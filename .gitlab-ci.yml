image: maven:3-jdk-11

stages:
    - build
    - test
    - image

#Build stage
buildAuthService:
    stage: build
    script:
        - cd authService
        - mvn package -Dmaven.test.skip=true
    artifacts:
        paths:
            - target
        expire_in: 20 mins

buildProfileService:
    stage: build
    script:
        - cd profileService
        - mvn package -Dmaven.test.skip=true
    artifacts:
        paths:
            - target
        expire_in: 20 mins

#Test stage
testAuthService:
    stage: test
    needs: ["buildAuthService"]
    script:
        - cd authService
        - mvn surefire:test

testProfileService:
    stage: test
    needs: ["buildProfileService"]
    script:
        - cd profileService
        - mvn surefire:test

#Build and push docker image
imageAuthService:
    stage: image
    image: docker:18-dind
    needs: ["testAuthService"]
    services:
        - name: docker:18-dind
          alias: thedockerhost
    variables:
        DOCKER_HOST: tcp://thedockerhost:2375/
        # Use the overlayfs driver for improved performance:
        DOCKER_DRIVER: overlay2
        DOCKER_TLS_CERTDIR: ""
    script: 
        - cd authService
        - docker build . -t timgroenen/kwetterauthservice
        - docker login --username $dockerUsername --password $dockerPassword
        - docker push timgroenen/kwetterauthservice
